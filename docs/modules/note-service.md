# 功能单元规格说明

## 基本信息
- **单元名称**：生活便签服务
- **路径**：backend/app/services/note_service.py
- **类型**：API服务

## 功能描述
提供生活便签的核心业务逻辑，包括创建、获取、更新、删除便签，以及处理与用户关联的便签查询和多媒体内容管理。该服务是生活便签功能模块的核心服务层，支持文本和图片混合内容的便签记录。

## 接口规范
### 输入
- **创建便签**:
  - `db`: SQLAlchemy Session - 数据库会话
  - `note_in`: NoteCreate - 便签创建模型，包含标题、内容等信息
  - `user_id`: str - 用户ID
  - `files`: List[UploadFile] (可选) - 上传的图片文件列表
  
- **获取便签**:
  - `db`: SQLAlchemy Session - 数据库会话
  - `note_id`: str - 便签ID
  
- **获取用户便签列表**:
  - `db`: SQLAlchemy Session - 数据库会话
  - `user_id`: str - 用户ID
  - `skip`: int (可选) - 分页起始位置，默认0
  - `limit`: int (可选) - 分页大小，默认50
  - `search`: str (可选) - 搜索关键词
  
- **更新便签**:
  - `db`: SQLAlchemy Session - 数据库会话
  - `note`: Note - 原便签数据库模型
  - `note_in`: NoteUpdate - 便签更新模型
  - `files`: List[UploadFile] (可选) - 新上传的图片文件列表
  - `delete_images`: List[str] (可选) - 要删除的图片ID列表

- **删除便签**:
  - `db`: SQLAlchemy Session - 数据库会话
  - `note_id`: str - 便签ID
  
- **上传便签图片**:
  - `file`: UploadFile - 上传的图片文件
  - `note_id`: str - 便签ID

### 输出
- **创建便签**: Note - 创建的便签数据库模型
- **获取便签**: Note | None - 获取的便签数据库模型或空
- **获取用户便签列表**: List[Note] - 便签数据库模型列表
- **更新便签**: Note - 更新后的便签数据库模型
- **删除便签**: bool - 删除是否成功
- **上传便签图片**: NoteImage - 创建的便签图片数据库模型

## 依赖关系
- **数据库模型层**: 依赖app.models.note.Note和app.models.note.NoteImage模型
- **数据校验层**: 依赖app.schemas.note中的Pydantic模型
- **文件存储服务**: 依赖app.services.storage_service处理图片文件的上传和存储
- **内容处理**: 依赖图片处理库进行图片压缩和格式转换
- **搜索服务**: 依赖全文搜索功能进行便签内容检索

## 副作用
- **数据库操作**: 向数据库添加、修改或删除便签记录
- **文件系统操作**: 存储和删除便签相关的图片文件
- **内容索引**: 更新便签搜索索引，便于快速检索

## 异常处理
- **文件上传错误**: 处理图片上传失败的情况
- **文件格式验证**: 验证上传图片的格式和大小
- **资源不存在**: 当便签不存在时，返回None或抛出404异常
- **权限验证**: 确保只有便签的创建者能够更新或删除

## 注意事项
- **图片处理**: 对上传的图片进行适当压缩和格式转换，优化存储和加载性能
- **内容安全**: 对便签内容进行敏感信息过滤和安全检查
- **搜索优化**: 实现便签内容的高效搜索，支持标题和内容的全文检索
- **多媒体支持**: 除图片外，未来可考虑扩展支持音频、视频等多媒体内容
- **离线同步**: 支持客户端离线创建便签后与服务器同步的机制 