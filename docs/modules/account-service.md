# 功能单元规格说明

## 基本信息
- **单元名称**：用户账户服务
- **路径**：backend/app/services/account_service.py
- **类型**：API服务

## 功能描述
提供用户账户相关的核心业务逻辑，包括用户注册、登录验证、账户信息管理等功能。该服务是用户系统模块的核心服务层，负责用户身份管理和授权。

## 接口规范
### 输入
- **用户注册**:
  - `db`: SQLAlchemy Session - 数据库会话
  - `user_in`: UserCreate - 用户创建模型，包含用户名、密码、手机号等信息
  
- **用户登录**:
  - `db`: SQLAlchemy Session - 数据库会话
  - `username`: str - 用户名或邮箱
  - `password`: str - 密码
  
- **获取用户信息**:
  - `db`: SQLAlchemy Session - 数据库会话
  - `user_id`: str - 用户ID
  
- **更新用户信息**:
  - `db`: SQLAlchemy Session - 数据库会话
  - `user`: User - 原用户数据库模型
  - `user_in`: UserUpdate - 用户更新模型
  
- **密码重置**:
  - `db`: SQLAlchemy Session - 数据库会话
  - `email`: str - 用户邮箱
  - `token`: str - 验证令牌
  - `new_password`: str - 新密码

- **验证码发送**:
  - `phone`: str - 手机号
  - `purpose`: str - 用途（注册/登录/找回密码）

### 输出
- **用户注册**: User - 创建的用户数据库模型
- **用户登录**: Token - 包含访问令牌和令牌类型
- **获取用户信息**: User | None - 获取的用户数据库模型或空
- **更新用户信息**: User - 更新后的用户数据库模型
- **密码重置**: bool - 重置是否成功
- **验证码发送**: bool - 发送是否成功

## 依赖关系
- **数据库模型层**: 依赖app.models.user.User模型
- **数据校验层**: 依赖app.schemas.user中的Pydantic模型
- **安全工具**: 依赖app.core.security模块进行密码哈希和验证
- **令牌服务**: 依赖app.core.jwt进行JWT令牌的创建和验证
- **外部服务**: 依赖短信API服务发送验证码
- **电子邮件服务**: 依赖邮件服务发送重置密码链接

## 副作用
- **用户注册**: 向数据库添加新用户记录
- **密码哈希**: 密码在存储前进行安全哈希处理
- **外部通信**: 发送验证码短信或邮件
- **登录记录**: 记录用户登录时间和IP
- **令牌生成**: 生成和存储身份验证令牌

## 异常处理
- **数据验证**: 验证用户输入的格式和合法性，如邮箱格式、密码强度
- **用户存在性检查**: 注册时检查用户名/邮箱是否已存在
- **登录失败处理**: 处理错误的密码尝试和账户锁定逻辑
- **外部服务错误**: 处理短信/邮件发送失败的情况

## 注意事项
- **安全性**: 所有密码都必须使用安全的哈希算法（如bcrypt）处理后再存储
- **接口防护**: 登录接口应实现限流和防暴力破解机制
- **令牌管理**: JWT令牌应有合理的过期时间和刷新机制
- **个人信息保护**: 确保用户敏感信息（如手机号）适当脱敏处理 